# SourceNavigator 架构文档

## 新架构概述

SourceNavigator 已经重构为基于进程分离的架构，MCP服务器现在运行在独立的进程中，通过node-ipc与VSCode扩展进程通信。

## 架构组件

### 1. 主扩展进程 (extension.ts)
- **职责**: VSCode扩展的主入口点，负责扩展生命周期管理
- **功能**:
  - 管理MCP服务器进程的启动和停止
  - 处理VSCode命令和事件
  - 工作区配置管理

### 2. MCP服务器进程 (mcpServerProcess.ts)
- **职责**: 独立运行的MCP服务器，处理外部客户端连接
- **功能**:
  - 运行HTTP/SSE服务器
  - 处理MCP协议消息
  - 通过IPC代理工具调用请求给扩展进程

### 3. IPC客户端 (ipcClient.ts)
- **职责**: 扩展进程中的IPC客户端，与MCP服务器进程通信
- **功能**:
  - 建立和维护IPC连接
  - 发送初始化和控制命令
  - 处理来自服务器的工具调用请求

### 4. 进程管理器 (processManager.ts)
- **职责**: 管理MCP服务器进程的完整生命周期
- **功能**:
  - 启动和停止服务器进程
  - 监控进程状态和健康状态
  - 错误处理和恢复

### 5. 全局状态管理 (globals.ts)
- **职责**: 维护扩展范围内的全局状态
- **功能**:
  - 进程引用管理
  - IPC客户端引用管理
  - 状态访问器

## 通信流程

### 启动流程
1. **扩展激活**: VSCode扩展启动
2. **进程启动**: ProcessManager启动MCP服务器进程
3. **IPC连接**: IPC客户端连接到服务器进程
4. **服务器初始化**: 通过IPC发送配置，初始化MCP服务器
5. **HTTP服务器**: MCP服务器进程启动HTTP/SSE服务器

### 工具调用流程
1. **外部请求**: AI客户端向MCP服务器发送工具调用请求
2. **IPC代理**: MCP服务器通过IPC将请求转发给扩展进程
3. **工具执行**: 扩展进程执行实际的工具逻辑
4. **结果返回**: 结果通过IPC返回给MCP服务器，再返回给客户端

### 停止流程
1. **停止请求**: 用户或扩展请求停止服务器
2. **IPC停止**: 通过IPC发送停止命令
3. **优雅关闭**: MCP服务器进程优雅关闭HTTP服务器
4. **进程终止**: 服务器进程退出
5. **资源清理**: ProcessManager清理所有资源

## 文件结构

```
src/
├── extension.ts           # 主扩展入口
├── mcpServerProcess.ts    # 独立的MCP服务器进程
├── ipcClient.ts          # IPC客户端
├── processManager.ts     # 进程生命周期管理
├── globals.ts            # 全局状态管理
├── config.ts             # 配置管理
├── tools.ts              # 工具定义
├── toolRunner.ts         # 工具执行器
└── helpers.ts            # 辅助函数
```

## 配置

扩展使用 `source-navigator.config.json` 文件进行配置：

```json
{
    "projectName": "my-project",
    "description": "Project description",
    "path": "/api/v1",
    "port": 8009
}
```

## 优势

### 1. 进程隔离
- MCP服务器崩溃不会影响VSCode扩展
- 更好的资源管理和内存隔离
- 独立的错误处理和恢复

### 2. 可扩展性
- 可以轻松添加多个MCP服务器实例
- 支持不同项目的独立配置
- 更好的性能监控和调试

### 3. 维护性
- 清晰的职责分离
- 模块化设计
- 更容易测试和调试

## 错误处理

### 进程级别错误
- 自动进程重启机制
- 优雅的错误恢复
- 详细的错误日志记录

### IPC通信错误
- 连接超时处理
- 自动重连机制
- 错误消息传播

### 工具执行错误
- 异常捕获和包装
- 错误消息格式化
- 客户端友好的错误响应

## 开发和调试

### 构建
```bash
npm run compile
```

### 调试
- 使用VSCode调试器调试扩展进程
- 查看输出面板中的MCP服务器进程日志
- 使用VSCode开发者工具调试

### 日志
- 扩展日志: VSCode输出面板
- 服务器进程日志: 控制台输出
- IPC通信日志: 两个进程的控制台输出